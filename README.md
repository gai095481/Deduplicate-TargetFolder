# Deduplicate-TargetFolder.ps1 User Guide

This PowerShell script automates the process of finding and removing redundant files in a specified "target" folder by comparing them against a designated "reference" folder. It uses the external `czkawka-CLI.exe` tool for efficient duplicate detection based on file hashes.

## Requirements

1. **PowerShell:** The script is designed for PowerShell. It has been tested with Windows PowerShell 5.1 and PowerShell 7.x. While PowerShell 7 might offer performance benefits, the script should work on 5.1.
2. **`czkawka-CLI.exe`:** This external executable must be installed and accessible from your system's command PATH. You can download it from the [Czkawka releases page](https://github.com/qarmin/czkawka/releases). Ensure you have a version that supports the command-line options used by the script (e.g., `dup`, `--search-method HASH`, `--directories`, `--compact-file-to-save`).
3. **.NET Framework/ Runtime:** The script uses standard .NET libraries. PowerShell itself requires .NET, so this is typically already available.
4. **Windows OS:** The script is designed for Windows 11, particularly for moving files to the Recycle Bin using .NET methods. Folder path conventions assume Windows.

## Script Functionality

The script performs the following steps:

1. **Input Validation:** Checks if the provided reference and target folder paths exist and are directories.
2. **Intra-Target Folder Check:** Runs `czkawka-CLI.exe` to scan the *target* folder alone for any internal duplicates. If duplicates are found, the script **halts** with an error message. You must resolve these internal duplicates first.
3. **Cross-Folder Duplicate Detection:** Runs `czkawka-CLI.exe` to scan both the *reference* and *target* folders, identifying files that are duplicates *between* these two locations.
4. **Result Parsing:** Reads the JSON output file generated by `czkawka` and parses it to identify which of the duplicate files are located within the *target* folder.
5. **Action Execution:**
    * **Dry-Run (`-DryRun`):** Lists the files in the *target* folder that would be moved to the Recycle Bin. No actual file system changes are made.
    * **Normal Mode:** Moves the identified duplicate files from the *target* folder to the Windows Recycle Bin.
6. **Final Reporting:** Provides a summary of the operation, including the number of files processed and any errors encountered.

## Usage

Open a PowerShell terminal, navigate to the directory containing the script, and run it with the required parameters.

### Syntax

```powershell
.\Deduplicate-TargetFolder.ps1 -ReferenceFolderPath <String> -TargetFolderPath <String> [-OutputJsonFile <String>] [-DryRun]
```

### Parameters

* **`-ReferenceFolderPath`** (Mandatory): The full path to the folder containing the "master" or "reference" files. Duplicates found in the target folder that match files in this folder will be removed from the *target*.
* **`-TargetFolderPath`** (Mandatory): The full path to the folder from which you want to remove duplicate files.
* **`-OutputJsonFile`** (Optional): The name of the intermediate JSON file that `czkawka` will create to store its results. Default is `duplicates_output.json`. This file is created in the current working directory where the script is run.
* **`-DryRun`** (Optional Switch): If included, the script will perform all checks and identify the files that *would be* moved, but it will **not** actually move any files or make changes to the file system. Use this to preview the operation.

### Example Commands

1. **Perform a Dry-Run:**
    
    ```powershell
    .\Deduplicate-TargetFolder.ps1 -ReferenceFolderPath "C:\Path\To\Reference" -TargetFolderPath "C:\Path\To\Target" -DryRun
    ```
    
    This command checks for intra-folder duplicates in `C:\Path\To\Target`. If none are found, it then checks for cross-folder duplicates between `C:\Path\To\Reference` and `C:\Path\To\Target`. It lists the target files that would be moved and exits.
2. **Execute the Deduplication:**
    
    ```powershell
    .\Deduplicate-TargetFolder.ps1 -ReferenceFolderPath "C:\Path\To\Reference" -TargetFolderPath "C:\Path\To\Target"
    ```
    
    This command performs the full process. It checks for intra-folder duplicates (and exits if found). If not, it finds cross-folder duplicates and **moves** the identified duplicate files from `C:\Path\To\Target` to the Recycle Bin.
3. **Execute with Custom Output File:**
    
    ```powershell
    .\Deduplicate-TargetFolder.ps1 -ReferenceFolderPath "C:\Path\To\Reference" -TargetFolderPath "C:\Path\To\Target" -OutputJsonFile "my_results.json"
    ```

## How It Works Internally

1. **Path Handling:** The script ensures folder paths end with a backslash (`\`) for consistent internal comparison.
2. **czkawka Execution:** It uses the `&` call operator to execute `czkawka-CLI.exe` with the necessary arguments.
3. **JSON Parsing:** The script reads the JSON output file generated by `czkawka`. It correctly handles the specific structure where the root is a dictionary keyed by file size, containing arrays of duplicate groups, where each group is an array of file objects.
4. **File Matching:** It identifies files belonging to the target folder by performing a case-insensitive "starts with" check on the file paths provided by `czkawka`.
5. **Moving Files (Normal Mode):**
    * **Stable Method:** To avoid crashes encountered with the Windows Shell COM object (`Shell.Application`) under high load, the script uses `[Microsoft.VisualBasic.FileIO.FileSystem]::DeleteFile`.
    * This .NET method correctly moves files to the Windows Recycle Bin without the instability of repeated COM calls.
    * If the Visual Basic library fails to load (unlikely), it falls back to permanent file deletion using `[System.IO.File]::Delete`.
    * Files are processed in small batches purely for progress reporting; the .NET method itself doesn't require batching for stability.
    * Error handling is included for common issues like access denied or files in use.

## Troubleshooting & Known Issues

* **`czkawka-CLI.exe` Not Found:** Ensure `czkawka-CLI.exe` is in your system PATH or provide the full path to it within the script.
* **Intra-Folder Duplicates Error:** If the script reports duplicates within the target folder, you must run `czkawka` manually on that folder first to resolve them (e.g., delete the unwanted internal duplicates).
* **Crashes (Historical):** Earlier versions of this script using `Shell.Application` COM objects in a loop could crash (`0xc0000005`) with large numbers of files. This is resolved by switching to the `[Microsoft.VisualBasic.FileIO.FileSystem]::DeleteFile` method.
* **Performance:** The script's speed is primarily dependent on `czkawka`'s scanning speed. Moving files using the .NET Visual Basic method is generally fast and stable.
* **Permissions:** Ensure the PowerShell process has the necessary permissions to read from both folders and delete/move files from the target folder.

## Output & Logging

The script provides detailed console output, including:

* Progress messages for each `czkawka` scan.
* Confirmation of successful scans or detection of duplicates.
* A list of files that would be affected (in `-DryRun` mode).
* Progress messages for each file being moved (in Normal mode).
* Success or failure messages for individual file moves.
* A final summary report showing the total number of files moved or identified and any errors.

The intermediate JSON file generated by `czkawka` (e.g., `duplicates_output.json`) is left in the directory where the script is run. You can inspect this file if needed for detailed results from `czkawka`.

